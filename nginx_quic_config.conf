# Optimized Nginx Configuration for QUIC + ECH (HTTP/3)
# Requires Nginx 1.25+ with QUIC module and OpenSSL 3.0+
# Build command: ./configure --with-http_v3_module --with-http_quic_module --with-openssl=../openssl

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Enhanced logging for QUIC performance monitoring
    log_format quic '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '$http3 $request_time $upstream_response_time';

    access_log /var/log/nginx/access.log quic;
    error_log /var/log/nginx/error.log;

    # QUIC-specific optimizations
    quic_gso on;                    # Generic Segmentation Offload
    quic_mtu_discovery on;          # Path MTU discovery
    quic_retry on;                  # Address validation

    # SSL/TLS optimizations for QUIC
    ssl_protocols TLSv1.3;
    ssl_early_data on;              # 0-RTT resumption
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ECH (Encrypted Client Hello) - requires OpenSSL with ECH support
    # ssl_ech on;
    # ssl_ech_config_file /etc/nginx/ech_config.conf;

    server {
        listen 443 ssl http2;       # HTTP/2 fallback
        listen 443 quic reuseport;  # QUIC primary
        http3 on;                   # Enable HTTP/3

        server_name example.com;

        # SSL certificates (use Let's Encrypt in production)
        ssl_certificate /etc/ssl/certs/example.com.crt;
        ssl_certificate_key /etc/ssl/private/example.com.key;

        # Security headers
        add_header Strict-Transport-Security "max-age=63072000" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;

        # Advertise QUIC support
        add_header Alt-Svc 'h3=":443"; ma=86400, h3-29=":443"; ma=86400';

        # Compression optimizations
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        # Brotli compression (if available)
        # brotli on;
        # brotli_comp_level 6;
        # brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        location / {
            # Enable caching
            expires 1y;
            add_header Cache-Control "public, immutable";

            # Resource hints for predictive prefetch
            add_header Link "</css/style.css>; rel=preload; as=style";
            add_header Link "</js/app.js>; rel=preload; as=script";

            try_files $uri $uri/ =404;
        }

        # API endpoints with compression
        location /api/ {
            # Protobuf or compressed JSON
            add_header Content-Type "application/x-protobuf";
            # add_header Content-Encoding "br";  # Brotli

            proxy_pass http://backend;
            proxy_set_header Accept-Encoding "";
        }
    }
}

# QUIC stream configuration
stream {
    server {
        listen 443 quic reuseport;
        http3 on;

        # QUIC-specific stream settings
        quic_max_concurrent_streams 128;
        quic_initial_max_data 1048576;
        quic_initial_max_stream_data_bidi_local 65536;
        quic_initial_max_stream_data_bidi_remote 65536;
        quic_initial_max_stream_data_uni 65536;
    }
}